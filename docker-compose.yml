version: "3.9"

services:
  postgres:
    image: postgis/postgis:14-3.2
    container_name: heartguard-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    ports:
      - "5432:5432"
    shm_size: "1g"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: heartguard-redis
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "PING"]
      interval: 5s
      timeout: 2s
      retries: 10

  influxdb:
    image: influxdb:2.7-alpine
    container_name: heartguard-influxdb
    ports:
      - "8086:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: influxdb123
      DOCKER_INFLUXDB_INIT_ORG: heartguard
      DOCKER_INFLUXDB_INIT_BUCKET: timeseries
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: heartguard-dev-token-change-me
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2

  ai-prediction-service:
    build:
      context: ./services/ai-prediction
      dockerfile: Dockerfile
    container_name: heartguard-ai-prediction
    ports:
      - "5008:5008"
    environment:
      FLASK_HOST: 0.0.0.0
      FLASK_PORT: 5008
      FLASK_DEBUG: "False"
      PREDICTION_THRESHOLD: "0.6"
      JWT_SECRET: "heartguard-jwt-secret-change-in-production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5008/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - ./services/ai-prediction/models:/app/models:ro

  ai-monitor:
    build:
      context: ./services/ai-monitor
      dockerfile: Dockerfile
    container_name: heartguard-ai-monitor
    environment:
      # InfluxDB
      INFLUXDB_URL: http://influxdb:8086
      INFLUXDB_TOKEN: heartguard-dev-token-change-me
      INFLUXDB_ORG: heartguard
      INFLUXDB_BUCKET: timeseries
      # PostgreSQL
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_DB: heartguard
      POSTGRES_USER: heartguard_app
      POSTGRES_PASSWORD: dev_change_me
      # AI Service
      AI_SERVICE_URL: http://ai-prediction-service:5008
      AI_PREDICTION_THRESHOLD: "0.6"
      # Auth Service
      AUTH_SERVICE_URL: http://auth-service:8081
      INTERNAL_SERVICE_KEY: dev_internal_key
      # Monitor Config
      MONITOR_INTERVAL: "60"
      LOOKBACK_WINDOW: "300"
      BATCH_SIZE: "10"
      # Notifications
      ENABLE_NOTIFICATIONS: "true"
      NOTIFICATION_SERVICE_URL: http://notification-service:8083
      # Logging
      LOG_LEVEL: INFO
    depends_on:
      postgres:
        condition: service_healthy
      influxdb:
        condition: service_healthy
      ai-prediction-service:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres_data:
  influxdb_data:
  influxdb_config: