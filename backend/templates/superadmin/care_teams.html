{{define "superadmin/care_teams.html"}} {{template "layout" .}} {{end}}
{{define "superadmin/care_teams.html:content"}}
<section class="hg-section">
        <div class="hg-flex-between">
                <h1>Equipos de cuidado</h1>
        </div>
        <div class="hg-card">
                <h3>Registrar equipo</h3>
                <form method="post" action="/superadmin/care-teams" class="hg-form-grid">
                        <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
                        <div class="hg-form-field">
                                <label for="team-name">Nombre</label>
                                <input id="team-name" name="name" type="text" required placeholder="Nombre del equipo" />
                        </div>
                        <div class="hg-form-field">
                                <label for="team-org">Organización</label>
                                <select id="team-org" name="org_id">
                                        <option value="">Sin organización</option>
                                        {{range .Data.Organizations}}
                                        <option value="{{.ID}}">{{.Name}}</option>
                                        {{end}}
                                </select>
                        </div>
                        <div class="hg-form-actions">
                                <button type="submit">Crear equipo</button>
                        </div>
                </form>
        </div>
</section>

<section class="hg-section">
        <div class="hg-grid">
                {{range .Data.Teams}}
                {{$team := .Team}}
                <div class="hg-card">
                        <div class="hg-flex-between hg-card-header">
                                <div>
                                        <h3>{{$team.Name}}</h3>
                                        <p class="hg-muted">{{if $team.OrgName}}{{$team.OrgName}}{{else}}Sin organización{{end}}</p>
                                </div>
                                <form method="post" action="/superadmin/care-teams/{{$team.ID}}/delete" data-hg-confirm="¿Eliminar equipo?" class="hg-inline-form">
                                        <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                                        <button type="submit" class="hg-link hg-link-danger">Eliminar</button>
                                </form>
                        </div>

                        <details class="hg-details">
                                <summary>Editar equipo</summary>
                                <form method="post" action="/superadmin/care-teams/{{$team.ID}}/update" class="hg-form-grid">
                                        <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                                        <div class="hg-form-field">
                                                <label>Nombre</label>
                                                <input name="name" type="text" value="{{$team.Name}}" required />
                                        </div>
                                        <div class="hg-form-field">
                                                <label>Organización</label>
                                                <select name="org_id">
                                                        <option value="">Sin organización</option>
                                                        {{range $.Data.Organizations}}
                                                        <option value="{{.ID}}" {{if eq .ID (stringValue $team.OrgID)}}selected{{end}}>{{.Name}}</option>
                                                        {{end}}
                                                </select>
                                        </div>
                                        <div class="hg-form-actions">
                                                <button type="submit">Guardar cambios</button>
                                        </div>
                                </form>
                        </details>

                        <div class="hg-subsection">
                                <h4>Miembros</h4>
                                <form method="post" action="/superadmin/care-teams/{{$team.ID}}/members" class="hg-form-inline">
                                        <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                                        <label>
                                                Usuario
                                                <select name="user_id" required>
                                                        <option value="">Selecciona usuario</option>
                                                        {{range $.Data.Users}}
                                                        <option value="{{.ID}}">{{.Name}} · {{.Email}}</option>
                                                        {{end}}
                                                </select>
                                        </label>
                                        <label>
                                                Rol en equipo
                                                <input type="text" name="role_in_team" required placeholder="Coordinador, Enfermería..." />
                                        </label>
                                        <button type="submit">Agregar</button>
                                </form>
                                <table class="hg-table">
                                        <thead>
                                                <tr>
                                                        <th>Miembro</th>
                                                        <th>Email</th>
                                                        <th>Rol</th>
                                                        <th>Ingreso</th>
                                                        <th></th>
                                                </tr>
                                        </thead>
                                        <tbody>
                                                {{range .Members}}
                                                <tr>
                                                        <td>{{.UserName}}</td>
                                                        <td>{{.UserEmail}}</td>
                                                        <td>{{.RoleInTeam}}</td>
                                                        <td>{{formatTime .JoinedAt}}</td>
                                                        <td class="hg-flex">
                                                                <details>
                                                                        <summary>Editar</summary>
                                                                        <form method="post" action="/superadmin/care-teams/{{.CareTeamID}}/members/{{.UserID}}/update" class="hg-form-grid">
                                                                                <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                                                                                <div class="hg-form-field">
                                                                                        <label>Rol</label>
                                                                                        <input type="text" name="role_in_team" value="{{.RoleInTeam}}" required />
                                                                                </div>
                                                                                <div class="hg-form-actions">
                                                                                        <button type="submit">Guardar</button>
                                                                                </div>
                                                                        </form>
                                                                </details>
                                                                <form method="post" action="/superadmin/care-teams/{{.CareTeamID}}/members/{{.UserID}}/delete" class="hg-inline-form" data-hg-confirm="¿Quitar miembro?">
                                                                        <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                                                                        <button type="submit" class="hg-link hg-link-danger">Quitar</button>
                                                                </form>
                                                        </td>
                                                </tr>
                                                {{else}}
                                                <tr>
                                                        <td colspan="5" class="hg-empty-cell">Sin miembros registrados.</td>
                                                </tr>
                                                {{end}}
                                        </tbody>
                                </table>
                        </div>

                        <div class="hg-subsection">
                                <h4>Pacientes asignados</h4>
                                <form method="post" action="/superadmin/care-teams/{{$team.ID}}/patients" class="hg-form-inline">
                                        <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                                        <label>
                                                Paciente
                                                <select name="patient_id" required>
                                                        <option value="">Selecciona paciente</option>
                                                        {{range $.Data.Patients}}
                                                        <option value="{{.ID}}">{{.Name}}</option>
                                                        {{end}}
                                                </select>
                                        </label>
                                        <button type="submit">Asignar</button>
                                </form>
                                <table class="hg-table">
                                        <thead>
                                                <tr>
                                                        <th>Paciente</th>
                                                        <th></th>
                                                </tr>
                                        </thead>
                                        <tbody>
                                                {{range .Patients}}
                                                <tr>
                                                        <td>{{.PatientName}}</td>
                                                        <td class="hg-flex-end">
                                                                <form method="post" action="/superadmin/care-teams/{{.CareTeamID}}/patients/{{.PatientID}}/delete" class="hg-inline-form" data-hg-confirm="¿Remover paciente?">
                                                                        <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                                                                        <button type="submit" class="hg-link">Quitar</button>
                                                                </form>
                                                        </td>
                                                </tr>
                                                {{else}}
                                                <tr>
                                                        <td colspan="2" class="hg-empty-cell">Sin pacientes asignados.</td>
                                                </tr>
                                                {{end}}
                                        </tbody>
                                </table>
                        </div>
                </div>
                {{else}}
                <div class="hg-card">
                        <p class="hg-empty-cell">No hay equipos registrados.</p>
                </div>
                {{end}}
        </div>
</section>
{{end}}
