{{define "superadmin/api_keys.html"}} {{template "layout" .}} {{end}} {{define "superadmin/api_keys.html:content"}}
<section class="hg-section">
	<h1>API Keys</h1>
	<div class="hg-card">
		<h2>Crear nueva API Key</h2>
		<form method="post" action="/superadmin/api-keys" class="hg-form-grid">
			<input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
			<div class="hg-form-field">
				<label for="api-label">Nombre</label>
				<input id="api-label" name="label" required maxlength="120" />
				<span class="hg-field-hint">Asigna un nombre descriptivo que te permita identificar esta clave rápidamente.</span>
			</div>
			<div class="hg-form-field">
				<label for="api-owner">Usuario propietario (UUID opcional)</label>
				<input id="api-owner" name="owner_user_id" placeholder="00000000-0000-0000-0000-000000000000" />
				<span class="hg-field-hint">Puedes vincular la clave a un usuario específico o dejarlo vacío para uso compartido.</span>
			</div>
			<div class="hg-form-field">
				<label for="api-exp">Expira (opcional)</label>
				<input id="api-exp" name="expires_at" type="datetime-local" />
				<span class="hg-field-hint">Define fecha y hora límite para invalidar automáticamente la clave.</span>
			</div>
			<fieldset class="hg-fieldset">
				<legend>Permisos</legend>
				<p class="hg-hint">Selecciona los alcances que tendrá la clave al consumir la API.</p>
				<div class="hg-grid-permissions">
					{{range .Data.Permissions}}
					<label> <input type="checkbox" name="permissions" value="{{.Code}}" /> {{.Code}} — {{.Description}} </label>
					{{end}}
				</div>
			</fieldset>
			<div class="hg-form-actions">
				<button type="submit">Crear API Key</button>
			</div>
		</form>
		<p class="hg-hint">El secreto se mostrará una sola vez después de crear la clave. Guárdalo en un lugar seguro.</p>
	</div>
</section>

<section class="hg-section">
	<div class="hg-toolbar">
		<form method="get" action="/superadmin/api-keys" class="hg-form-inline">
			<label> <input type="checkbox" name="show" value="all" {{if .Data.ShowInactive}}checked{{end}} class="hg-autoform" /> Mostrar revocadas </label>
		</form>
	</div>
	<table class="hg-table">
		<thead>
			<tr>
				<th>Nombre</th>
				<th>Propietario</th>
				<th>Permisos</th>
				<th>Creada</th>
				<th>Expira</th>
				<th>Estado</th>
				<th></th>
			</tr>
		</thead>
		<tbody>
			{{range .Data.Keys}} {{$key := .}}
			<tr class="{{if $key.Revoked}}hg-row-muted{{end}}">
				<td>{{$key.Label}}</td>
				<td>{{if $key.OwnerUserID}}{{$key.OwnerUserID}}{{else}}—{{end}}</td>
				<td>
					{{if $key.Scopes}}
					<ul class="hg-list-compact">
						{{range $key.Scopes}}
						<li>{{.}}</li>
						{{end}}
					</ul>
					{{else}}—{{end}}
				</td>
				<td>{{formatTime $key.CreatedAt}}</td>
				<td>{{formatTimePtr $key.ExpiresAt}}</td>
				<td>
					<span class="hg-status-chip {{if $key.Revoked}}is-danger{{else}}is-success{{end}}"> {{if $key.Revoked}}Revocada{{else}}Activa{{end}} </span>
				</td>
				<td class="hg-flex">
					<details>
						<summary>Permisos</summary>
						<form method="post" action="/superadmin/api-keys/{{$key.ID}}/permissions" class="hg-form-grid">
							<input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
							<input type="hidden" name="redirect" value="{{if $.Data.ShowInactive}}/superadmin/api-keys?show=all{{else}}/superadmin/api-keys{{end}}" />
							<div class="hg-grid-permissions">
								{{range $.Data.Permissions}}
								<label>
									<input type="checkbox" name="permissions" value="{{.Code}}" {{if hasScope $key.Scopes .Code}}checked{{end}} {{if $key.Revoked}}disabled{{end}} /> {{.Code}}
								</label>
								{{end}}
							</div>
							<div class="hg-form-actions">
								<button type="submit" {{if $key.Revoked}}disabled{{end}}>Actualizar</button>
							</div>
						</form>
					</details>
					{{if not $key.Revoked}}
					<form method="post" action="/superadmin/api-keys/{{$key.ID}}/revoke" data-hg-confirm="¿Revocar esta API Key?">
						<input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
						<input type="hidden" name="redirect" value="{{if $.Data.ShowInactive}}/superadmin/api-keys?show=all{{else}}/superadmin/api-keys{{end}}" />
						<button type="submit" class="hg-link hg-link-danger">Revocar</button>
					</form>
					{{end}}
				</td>
			</tr>
			{{else}}
			<tr>
				<td colspan="7" class="hg-empty-cell">No hay API Keys registradas.</td>
			</tr>
			{{end}}
		</tbody>
	</table>
</section>
{{end}}
