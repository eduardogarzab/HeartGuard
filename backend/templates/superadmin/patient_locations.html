{{define "superadmin/patient_locations.html"}} {{template "layout" .}} {{end}} {{define "superadmin/patient_locations.html:content"}}
<section class="hg-section">
	<div class="hg-flex-between">
		<h1>Ubicaciones de pacientes</h1>
	</div>
	<div class="hg-card">
		<form method="get" action="/superadmin/locations/patients" class="hg-form-grid">
			<div class="hg-form-field">
				<label for="patient-filter">Paciente</label>
				<select id="patient-filter" name="patient_id" class="hg-select-search">
					<option value="">Todos</option>
					{{range .Data.Patients}}
					<option value="{{.ID}}" {{if eq $.Data.SelectedPatientID .ID}}selected{{end}}>{{.Name}}</option>
					{{end}}
				</select>
			</div>
			<div class="hg-form-field">
				<label for="from-date">Desde</label>
				<input id="from-date" name="from" type="date" value="{{.Data.From}}" />
			</div>
			<div class="hg-form-field">
				<label for="to-date">Hasta</label>
				<input id="to-date" name="to" type="date" value="{{.Data.To}}" />
			</div>
			<div class="hg-form-actions">
				<button type="submit">Filtrar</button>
			</div>
		</form>
	</div>
</section>

<section class="hg-section">
	<div class="hg-card">
		<h3>Registrar ubicación manual</h3>
		<form method="post" action="/superadmin/locations/patients" class="hg-form-grid">
			<input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
			<input type="hidden" name="from" value="{{.Data.From}}" />
			<input type="hidden" name="to" value="{{.Data.To}}" />
			<div class="hg-form-field">
				<label for="patient-select">Paciente</label>
				<select id="patient-select" name="patient_id" required class="hg-select-search">
					<option value="">Seleccione un paciente</option>
					{{range .Data.Patients}}
					<option value="{{.ID}}" {{if eq $.Data.SelectedPatientID .ID}}selected{{end}}>{{.Name}}</option>
					{{end}}
				</select>
			</div>
			<div class="hg-form-field">
				<label for="recorded-at">Fecha y hora</label>
				<input id="recorded-at" name="recorded_at" type="datetime-local" />
				<span class="hg-field-hint">Opcional. Si se omite se usará la hora actual.</span>
			</div>
			<div class="hg-form-field">
				<label for="latitude">Latitud</label>
				<input id="latitude" name="latitude" type="number" step="any" min="-90" max="90" required />
			</div>
			<div class="hg-form-field">
				<label for="longitude">Longitud</label>
				<input id="longitude" name="longitude" type="number" step="any" min="-180" max="180" required />
			</div>
			<div class="hg-form-field">
				<label for="accuracy">Precisión (m)</label>
				<input id="accuracy" name="accuracy_m" type="number" step="any" min="0" />
			</div>
			<div class="hg-form-field">
				<label for="source">Fuente</label>
				<input id="source" name="source" type="text" maxlength="40" placeholder="GPS, manual, etc." />
			</div>
			<div class="hg-form-actions">
				<button type="submit">Guardar ubicación</button>
			</div>
		</form>
	</div>
</section>

<section class="hg-section">
	<div class="hg-card">
		<h3>Historial de ubicaciones</h3>
		<div id="locations-map" style="height: 500px; border-radius: 8px;"></div>
	</div>
</section>

<script>
	window.addEventListener('load', () => {
		// 1. Inicializar el mapa de historial
		const mapElement = document.getElementById('locations-map');
		{{if .Data.Items}}
			const map = L.map(mapElement);
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);

			// Definición del ícono
			const historyIcon = L.icon({
				iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
				shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
				iconSize: [25, 41],
				iconAnchor: [12, 41],
				popupAnchor: [1, -34],
				shadowSize: [41, 41]
			});

			const markers = [];

			// 2. Iterar sobre las ubicaciones y agregar marcadores
			{{range $i, $loc := .Data.Items}}
				(function() {
					const lat = {{printf "%.6f" $loc.Latitude}};
					const lng = {{printf "%.6f" $loc.Longitude}};
					const timestamp = "{{formatTime $loc.RecordedAt}}";
					const patientName = "{{$loc.PatientName}}";
					
					const marker = L.marker([lat, lng], { icon: historyIcon });
					
					let popupContent = `<b>Paciente:</b> ${patientName}<br><b>Registrada:</b> ${timestamp}`;
					{{if .Source}} popupContent += `<br><b>Fuente:</b> {{.Source}}`; {{end}}
					{{if .AccuracyM}} popupContent += `<br><b>Precisión:</b> {{formatFloat64 .AccuracyM 2}}m`; {{end}}

					marker.bindPopup(popupContent);
					marker.addTo(map);
					markers.push([lat, lng]);
				})();
			{{end}}

			// 3. Centrar el mapa
			if (markers.length > 0) {
				map.fitBounds(markers);
			}

		{{else}}
			// Mensaje si no hay ubicaciones
			mapElement.innerHTML = '<p style="padding: 20px; text-align: center;">Sin ubicaciones registradas para los filtros seleccionados.</p>';
		{{end}}
	});
</script>
{{end}}