{{define "superadmin/patient_locations.html"}} {{template "layout" .}} {{end}} {{define "superadmin/patient_locations.html:content"}}
<section class="hg-section">
	<div class="hg-flex-between">
		<h1>Ubicaciones de pacientes</h1>
	</div>
	<div class="hg-card">
		<form method="get" action="/superadmin/locations/patients" class="hg-form-grid">
			<div class="hg-form-field">
				<label for="patient-filter">Paciente</label>
				<select id="patient-filter" name="patient_id">
					<option value="">Todos</option>
					{{range .Data.Patients}}
					<option value="{{.ID}}" {{if eq $.Data.SelectedPatientID .ID}}selected{{end}}>{{.Name}}</option>
					{{end}}
				</select>
			</div>
			<div class="hg-form-field">
				<label for="from-date">Desde</label>
				<input id="from-date" name="from" type="date" value="{{.Data.From}}" />
			</div>
			<div class="hg-form-field">
				<label for="to-date">Hasta</label>
				<input id="to-date" name="to" type="date" value="{{.Data.To}}" />
			</div>
			<div class="hg-form-actions">
				<button type="submit">Filtrar</button>
			</div>
		</form>
	</div>
</section>

<section class="hg-section">
	<div class="hg-card">
		<h3>Registrar ubicación manual</h3>
		<form method="post" action="/superadmin/locations/patients" class="hg-form-grid">
			<input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
			<input type="hidden" name="from" value="{{.Data.From}}" />
			<input type="hidden" name="to" value="{{.Data.To}}" />
			<div class="hg-form-field">
				<label for="patient-select">Paciente</label>
				<select id="patient-select" name="patient_id" required>
					<option value="">Seleccione un paciente</option>
					{{range .Data.Patients}}
					<option value="{{.ID}}" {{if eq $.Data.SelectedPatientID .ID}}selected{{end}}>{{.Name}}</option>
					{{end}}
				</select>
			</div>
			<div class="hg-form-field">
				<label for="recorded-at">Fecha y hora</label>
				<input id="recorded-at" name="recorded_at" type="datetime-local" />
				<span class="hg-field-hint">Opcional. Si se omite se usará la hora actual.</span>
			</div>
			<div class="hg-form-field">
				<label for="latitude">Latitud</label>
				<input id="latitude" name="latitude" type="number" step="any" min="-90" max="90" required />
			</div>
			<div class="hg-form-field">
				<label for="longitude">Longitud</label>
				<input id="longitude" name="longitude" type="number" step="any" min="-180" max="180" required />
			</div>
			<div class="hg-form-field">
				<label for="accuracy">Precisión (m)</label>
				<input id="accuracy" name="accuracy_m" type="number" step="any" min="0" />
			</div>
			<div class="hg-form-field">
				<label for="source">Fuente</label>
				<input id="source" name="source" type="text" maxlength="40" placeholder="GPS, manual, etc." />
			</div>
			<div class="hg-form-actions">
				<button type="submit">Guardar ubicación</button>
			</div>
		</form>
	</div>
</section>

<section class="hg-section">
	<div class="hg-card">
		<h3>Historial de ubicaciones</h3>
		<table class="hg-table">
			<thead>
				<tr>
					<th>Paciente</th>
					<th>Registrada</th>
					<th>Latitud</th>
					<th>Longitud</th>
					<th>Fuente</th>
					<th>Precisión (m)</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				{{range .Data.Items}}
				<tr>
					<td>{{if .PatientName}}{{.PatientName}}{{else}}—{{end}}</td>
					<td>{{formatTime .RecordedAt}}</td>
					<td>{{printf "%.6f" .Latitude}}</td>
					<td>{{printf "%.6f" .Longitude}}</td>
					<td>{{if .Source}}{{.Source}}{{else}}—{{end}}</td>
					<td>{{if .AccuracyM}}{{formatFloat64 .AccuracyM 2}}{{else}}—{{end}}</td>
					<td class="hg-actions">
						<form method="post" action="/superadmin/locations/patients/{{.ID}}/delete" data-hg-confirm="¿Eliminar ubicación?" class="hg-inline-form">
							<input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
							<input type="hidden" name="patient_id" value="{{$.Data.SelectedPatientID}}" />
							<input type="hidden" name="from" value="{{$.Data.From}}" />
							<input type="hidden" name="to" value="{{$.Data.To}}" />
							<button type="submit" class="hg-link hg-link-danger">Eliminar</button>
						</form>
					</td>
				</tr>
				{{else}}
				<tr>
					<td colspan="7" class="hg-empty-cell">Sin ubicaciones registradas.</td>
				</tr>
				{{end}}
			</tbody>
		</table>
	</div>
</section>
{{end}} {{define "scripts"}} {{if .Data.LocationsJSON}}
<script>
	document.addEventListener('DOMContentLoaded', function () {
		new SlimSelect({
			select: '#patient-filter',
			settings: {
				placeholderText: 'Seleccione un paciente',
				allowDeselect: true,
			},
		});
		new SlimSelect({
			select: '#patient-select',
			settings: {
				placeholderText: 'Seleccione un paciente',
			},
		});

		const locationsData = JSON.parse(`{{js .Data.LocationsJSON}}`);
		if (locationsData.length > 0) {
			const map = L.map('locations-map').setView([locationsData[0].lat, locationsData[0].lng], 13);
			L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', {
				maxZoom: 20,
				attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
			}).addTo(map);

			// Add a special marker for the most recent location
			const latest = locationsData[0];
			L.marker([latest.lat, latest.lng], {
				icon: L.icon({
					iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
					iconSize: [25, 41],
					iconAnchor: [12, 41],
					popupAnchor: [1, -34],
					shadowSize: [41, 41]
				})
			}).addTo(map).bindPopup(`<b>Reciente:</b> ${new Date(latest.ts).toLocaleString()}`);

			// Add markers for past locations
			for (let i = 1; i < locationsData.length; i++) {
				const loc = locationsData[i];
				L.marker([loc.lat, loc.lng]).addTo(map)
					.bindPopup(new Date(loc.ts).toLocaleString());
			}
		} else {
			// If there's no data, hide the map
			document.getElementById('locations-map').style.display = 'none';
		}
	});
</script>
{{end}} {{end}}
