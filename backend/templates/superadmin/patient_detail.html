{{define "superadmin/patient_detail.html"}} {{template "layout" .}} {{end}} {{define "superadmin/patient_detail.html:content"}}
<section class="hg-section">
	<div class="hg-detail-header">
		<img src="{{if .Data.Patient.ProfilePhotoURL}}{{.Data.Patient.ProfilePhotoURL}}{{else}}/assets/img/patient_placeholder.svg{{end}}" alt="Foto de perfil" class="hg-avatar hg-avatar--large" />
		<div>
			<h1>{{.Data.Patient.Name}}</h1>
			<p class="hg-detail-subtitle">Registrado {{formatTime .Data.Patient.CreatedAt}}</p>
		</div>
		<div class="hg-detail-meta">
			{{if .Data.Patient.OrgName}}<span class="hg-detail-pill">{{.Data.Patient.OrgName}}</span>{{end}}
			{{with .Data.RiskLevel}}
			<span class="hg-status-chip {{if eq . "alto"}}is-danger{{else if eq . "medio"}}is-warn{{else if eq . "bajo"}}is-success{{end}}">Riesgo: {{.}}</span>
			{{end}}
		</div>
	</div>
	<div class="hg-summary-grid">
		<article class="hg-summary-card">
			<span class="hg-summary-label">Organización</span>
			<span class="hg-summary-value">{{if .Data.Patient.OrgName}}{{.Data.Patient.OrgName}}{{else}}—{{end}}</span>
		</article>
		<article class="hg-summary-card">
			<span class="hg-summary-label">Nivel de riesgo</span>
			<span class="hg-summary-value">{{if .Data.RiskLevel}}{{.Data.RiskLevel}}{{else}}—{{end}}</span>
		</article>
		<article class="hg-summary-card">
			<span class="hg-summary-label">Sexo</span>
			<span class="hg-summary-value">{{if .Data.Patient.SexLabel}}{{.Data.Patient.SexLabel}}{{else}}—{{end}}</span>
		</article>
		<article class="hg-summary-card">
			<span class="hg-summary-label">Nacimiento</span>
			<span class="hg-summary-value">{{if .Data.Patient.Birthdate}}{{formatDatePtr .Data.Patient.Birthdate}}{{else}}—{{end}}</span>
		</article>
	</div>
</section>

<section class="hg-section">
	<div class="hg-card">
		<header class="hg-card-header">
			<h2>Equipos de cuidado</h2>
			<span class="hg-card-meta">{{len .Data.CareTeams}} equipos</span>
		</header>
		<table class="hg-table">
			<thead>
				<tr>
					<th>Equipo</th>
				</tr>
			</thead>
			<tbody>
				{{range .Data.CareTeams}}
				<tr>
					<td>{{.CareTeamName}}</td>
				</tr>
				{{else}}
				<tr>
					<td colspan="1" class="hg-empty-cell">Sin equipos asociados.</td>
				</tr>
				{{end}}
			</tbody>
		</table>
	</div>
</section>

<section class="hg-section">
	<div class="hg-card">
		<header class="hg-card-header">
			<h2>Cuidadores asignados</h2>
			<span class="hg-card-meta">{{len .Data.Caregivers}} cuidadores</span>
		</header>
		<table class="hg-table">
			<thead>
				<tr>
					<th>Cuidador</th>
					<th>Correo</th>
					<th>Relación</th>
					<th>Primario</th>
					<th>Inicio</th>
					<th>Fin</th>
					<th>Nota</th>
				</tr>
			</thead>
			<tbody>
				{{range .Data.Caregivers}}
				<tr>
					<td><a href="/superadmin/users/{{.CaregiverID}}" class="hg-link">{{.CaregiverName}}</a></td>
					<td>{{.CaregiverEmail}}</td>
					<td>{{if .RelationshipTypeLabel}}{{.RelationshipTypeLabel}}{{else}}—{{end}}</td>
					<td>{{if .IsPrimary}}Sí{{else}}No{{end}}</td>
					<td>{{formatDate .StartedAt}}</td>
					<td>{{if .EndedAt}}{{formatDatePtr .EndedAt}}{{else}}—{{end}}</td>
					<td>{{if .Note}}{{.Note}}{{else}}—{{end}}</td>
				</tr>
				{{else}}
				<tr>
					<td colspan="7" class="hg-empty-cell">Sin cuidadores asignados.</td>
				</tr>
				{{end}}
			</tbody>
		</table>
	</div>
</section>

<section class="hg-section">
	<div class="hg-card">
		<header class="hg-card-header">
			<h2>Últimas ubicaciones</h2>
			<span class="hg-card-meta">{{len .Data.Locations}} registros</span>
		</header>
		<table class="hg-table">
			<thead>
				<tr>
					<th>Registrado</th>
					<th>Latitud</th>
					<th>Longitud</th>
					<th>Fuente</th>
					<th>Precisión (m)</th>
				</tr>
			</thead>
			<tbody>
				{{range .Data.Locations}}
				<tr>
					<td>{{formatTime .RecordedAt}}</td>
					<td>{{printf "%.5f" .Latitude}}</td>
					<td>{{printf "%.5f" .Longitude}}</td>
					<td>{{if .Source}}{{.Source}}{{else}}—{{end}}</td>
					<td>{{if .AccuracyText}}{{.AccuracyText}}{{else}}—{{end}}</td>
				</tr>
				{{else}}
				<tr>
					<td colspan="5" class="hg-empty-cell">Sin ubicaciones registradas.</td>
				</tr>
				{{end}}
			</tbody>
		</table>
	</div>
</section>
{{end}} {{define "scripts"}} {{if .Data.LocationsJSON}}
<script>
	document.addEventListener('DOMContentLoaded', function () {
		const locationsData = JSON.parse(`{{js .Data.LocationsJSON}}`);
		if (locationsData.length > 0) {
			const map = L.map('locations-map').setView([locationsData[0].lat, locationsData[0].lng], 13);
			L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', {
				maxZoom: 20,
				attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
			}).addTo(map);

			const latest = locationsData[0];
			L.marker([latest.lat, latest.lng], {
				icon: L.icon({
					iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
					iconSize: [25, 41],
					iconAnchor: [12, 41],
					popupAnchor: [1, -34],
					shadowSize: [41, 41]
				})
			}).addTo(map).bindPopup(`<b>Reciente:</b> ${new Date(latest.ts).toLocaleString()}`);

			for (let i = 1; i < locationsData.length; i++) {
				const loc = locationsData[i];
				L.marker([loc.lat, loc.lng]).addTo(map)
					.bindPopup(new Date(loc.ts).toLocaleString());
			}
		} else {
			document.getElementById('locations-map').style.display = 'none';
		}
	});
</script>
{{end}} {{end}}
